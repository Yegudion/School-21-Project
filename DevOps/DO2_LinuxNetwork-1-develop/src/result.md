# Сети в Linux


## Part 1. Инструмент **ipcalc**

#### 1.1. Сети и маски
1)
![ipcalc](Pictures/Part_1/1_1_1.png "Скриншот 1 - адрес сети 192.167.38.54/13")\
Скриншот 1 - адрес сети 192.167.38.54/13
#

2)
![ipcalc](Pictures/Part_1/1_1_2.png "Скриншот 2 - перевод маски 255.255.255.0 в префиксную и двоичную запись")\
Скриншот 2 - перевод маски 255.255.255.0 в префиксную и двоичную запись(префиксная запись - /24)
#

![ipcalc](Pictures/Part_1/1_1_3.png "Скриншот 3 - перевод маски /15 в обычную и двоичную")\
Скриншот 3 - перевод маски /15 в обычную и двоичную
#

#### Перевод 11111111.11111111.11111111.11110000 проиходит в ручную:
- В обычном виде - 255.255.255.240
- В формате маски - /24


![ipcalc](Pictures/Part_1/1_1_4.png "Скриншот 4 - проверка ip 255.255.255.240")\
Скриншот 4 - проверка ip 255.255.255.240
#


![ipcalc](Pictures/Part_1/1_1_5.png "Скриншот 5 - минимальный и максимальный хост в сети 12.167.38.4/8")\
Скриншот 5 - минимальный и максимальный хост в сети 12.167.38.4/8
#

![ipcalc](Pictures/Part_1/1_1_6.png "Скриншот 6 - минимальный и максимальный хост в сети 12.167.38.4/11111111.11111111.00000000.00000000(255.255.0.0)")\
Скриншот 6 - минимальный и максимальный хост в сети 12.167.38.4/11111111.11111111.00000000.00000000(255.255.0.0)
#

![ipcalc](Pictures/Part_1/1_1_7.png "Скриншот 7 - минимальный и максимальный хост в сети 12.167.38.4/ 255.255.254.0")\
Скриншот 7 - минимальный и максимальный хост в сети 12.167.38.4/ 255.255.254.0
#

![ipcalc](Pictures/Part_1/1_1_8.png "Скриншот 8 - минимальный и максимальный хост в сети 12.167.38.4/4")\
Скриншот 8 - минимальный и максимальный хост в сети 12.167.38.4/4
#

#### 1.2. localhost
#### Так как ip localhost стандартное, официально зарезервированное доменное имя для частных IP-адресов в диапазоне 127.0.0.1 — 127.255.255.254, следоватлеьно подходят ip: **127.0.0.2**, **127.1.0.1**

#### 1.3. Диапазоны и сегменты сетей
1) #### Диапазон частных ip адресов
- 10.0.0.0 - 10.255.255.255

- 172.16.0.0 - 172.31.255.255

- 192.168.0.0 - 192.168.255.255

Следовательно из списка в качестве частных можно использовать ip: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10

Остальные ip адреса можно использовать как в качетсве публичных

2) #### Диапазон частных ip адресов

![ipcalc](Pictures/Part_1/1_1_9.png "Скриншот 9 - Диапазон шлюзов ip 10.10.0.0/18")\
Скриншот 9 - Диапазон шлюзов ip 10.10.0.0/18

- Из диапазона 10.10.0.1 - 10.10.63.254 следует, что ip 10.10.0.2, 10.10.10.10, 10.10.1.255 могут быть ip адресами шлюза

#

## Part 2. Статическая маршрутизация между двумя машинами

![ipcalc](Pictures/Part_2/1_ws1.png "Скриншот 10 -Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_2/1_ws2.png "Скриншот 11 - Существующие сетевые интерфейсы")\
Скриншот 10 и 11 - Существующие сетевые интерфейсы 

#

![ipcalc](Pictures/Part_2/2_ws1.png "Скриншот 11 -Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_2/2_ws2.png "Скриншот 12 - Существующие сетевые интерфейсы")\
Скриншот 11 и 12 - Задание сетевых интерфейсов для ws1 и ws2.
(ws1 - 192.168.100.10/16  ws2 - 172.24.116.8/12)
- comand `sudo vim /etc/netplan/00-installer-config.yaml`

#

![ipcalc](Pictures/Part_2/3_ws1.png "Скриншот 13 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_2/3_ws2.png "Скриншот 14 - Существующие сетевые интерфейсы")
Скриншот 13 и 14 -  Перезагрузка сетевых служб командой: `sudo netplan apply` 

#### 2.1. Добавление статического маршрута вручную

![ipcalc](Pictures/Part_2/4_ws1.png "Скриншот 15 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_2/4_ws2.png "Скриншот 16 - Существующие сетевые интерфейсы")
Скриншот 15 и 16 -  Добавление статических маршрутов от одной машины до другой и обратно при помощи команды вида `ip r add *** dev enp0s3`

#

![ipcalc](Pictures/Part_2/5_ws1.png "Скриншот 16 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_2/5_ws2.png "Скриншот 17 - Существующие сетевые интерфейсы")
Скриншот 16 и 17 -  Пропинговка соединения между машинами

#### 2.2. Добавление статического маршрута с сохранением
![ipcalc](Pictures/Part_2/6_ws1.png "Скриншот 18 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_2/6_ws2.png "Скриншот 19 - Существующие сетевые интерфейсы")
Скриншот 18 и 19 - Добавление статистичекого маршрута через `/etc/netplan/00-installer-config.yaml`

#
![ipcalc](Pictures/Part_2/7_ws1.png "Скриншот 20 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_2/7_ws2.png "Скриншот 21 - Существующие сетевые интерфейсы")
Скриншот 20 и 21 - Перезагрузка сетевых служб и пропинговка между серверами



## Part 3. Утилита **iperf3**

#### 3.1. Скорость соединения

- **8 Mbps** = 8 Mbps * (1 byte/8 bits) = **1 MB/s**
- **100 MB/s** = 100 MB/s * (8 Mb/MB) * 1024(Kbps/Mb) = **819 200 Kbps**
- **1 Gbps** = **1024** Mbps

#### 3.2. Утилита **iperf3**

- -s - запускает iperf3 в режиме сервера.
- -f - задает формат отчета(В данном случае используется формат **m - Mbits/s**)

- -c - запускает iperf3 в режиме клиента.


![ipcalc](Pictures/Part_3/1_ws1.png "Скриншот 22 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_3/1_ws2.png "Скриншот 23 - Существующие сетевые интерфейсы")
Скриншот 22 и 23 - Провека скорости соединения между ws1 и ws 2


## Part 4. Сетевой экран


#### 4.1. Утилита **iptables**
##### Создать файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2:


![ipcalc](Pictures/Part_4/1_ws1.png "Скриншот 24 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_4/1_ws2.png "Скриншот 25 - Существующие сетевые интерфейсы")
Скриншот 24 и 25 - Создание файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2

#

![ipcalc](Pictures/Part_4/2_ws1.png "Скриншот 26 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_4/2_ws2.png "Скриншот 27 - Существующие сетевые интерфейсы")
Скриншот 26 и 27 - Запуск команд 

- В первом случае(ws1) на пингование до подключение к порту 22, 80 невозможно

- Во втором случае(ws2) есть возможность пропинговать до подключение по порту 22 и 80, и после уже нельзя пропинговать сервер

#### 4.2. Утилита **nmap**
![ipcalc](Pictures/Part_4/3_ws2.png "Скриншот 28 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_4/4_ws2.png "Скриншот 29 - Существующие сетевые интерфейсы")
Скриншот 26 и 27 - Пропинговка защищенного сервера(ws1) и Дальнейшая проверка через `nmap` что сервер на самом деле работает

## Part 5. Статическая маршрутизация сети
#### 5.1. Настройка адресов машин

![ipcalc](Pictures/Part_5/1_r1.png "Скриншот 29 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/1_r2.png "Скриншот 30 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/1_ws11.png "Скриншот 31 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/1_ws21.png "Скриншот 32 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/1_ws22.png "Скриншот 33 - Существующие сетевые интерфейсы")
Скриншот 29 - 33 Настроить конфигурации машин в *etc/netplan/00-installer-config.yaml*

![ipcalc](Pictures/Part_5/2_r1.png "Скриншот 34 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/2_r2.png "Скриншот 35 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/2_ws11.png "Скриншот 36 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/2_ws21.png "Скриншот 37 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/2_ws22.png "Скриншот 38 - Существующие сетевые интерфейсы")
Скриншот 34 - 38 Применяем изменения и проверяем IP.
#

![ipcalc](Pictures/Part_5/3_ws22.png "Скриншот 39 - Существующие сетевые интерфейсы")
Скриншот 39 Пингуем ws22 c ws21
#
![ipcalc](Pictures/Part_5/4_r1.png "Скриншот 40 - Существующие сетевые интерфейсы")
Скриншот 40 Пингуем r1 c ws11

#### 5.2. Включение переадресации IP-адресов.
![ipcalc](Pictures/Part_5/5_r1.png "Скриншот 41 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/5_r2.png "Скриншот 42 - Существующие сетевые интерфейсы")

Скриншот 41 и 42 Выполнение конмады для переадрессации IP - 
`sysctl -w net.ipv4.ip_forward=1`

#
![ipcalc](Pictures/Part_5/6_r1.png "Скриншот 43 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/6_r2.png "Скриншот 44 - Существующие сетевые интерфейсы")
Скриншот 43 и 44 Открытие файла */etc/sysctl.conf* и добавление в него следующуй строки:
`net.ipv4.ip_forward = 1`

#
#### 5.3. Установка маршрута по-умолчанию
![ipcalc](Pictures/Part_5/7_r1.png "Скриншот 45 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/7_r2.png "Скриншот 46 - Существующие сетевые интерфейсы")
![ipcalc](Pictures/Part_5/7_ws11.png "Скриншот 47 - Существующие сетевые интерфейсы")
![ipcalc](Pictures/Part_5/7_ws21.png "Скриншот 48 - Существующие сетевые интерфейсы")
![ipcalc](Pictures/Part_5/7_ws22.png "Скриншот 49 - Существующие сетевые интерфейсы")
Скриншот 45 - 49 добавление стандартного пути *gateway*

#
![ipcalc](Pictures/Part_5/8_r1.png "Скриншот 50 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/8_r2.png "Скриншот 51 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/8_ws11.png "Скриншот 52 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/8_ws21.png "Скриншот 53 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/8_ws22.png "Скриншот 54 - Существующие сетевые интерфейсы")

Скриншот 50 - 54 установка сетевых служб и вывод комманды `ip r`
#

![ipcalc](Pictures/Part_5/9_ws11.png "Скриншот 55 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/9_r2.png "Скриншот 56 - Существующие сетевые интерфейсы")

Скриншот 55 и 56 Пропингование ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:

#### 5.4. Добавление статических маршрутов
![ipcalc](Pictures/Part_5/10_r1.png "Скриншот 57 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/10_r2.png "Скриншот 58 - Существующие сетевые интерфейсы")

Скриншот 57 и 58 добавление в роутеры r1 и r2 статические маршруты в файле конфигураций.

![ipcalc](Pictures/Part_5/11_r1.png "Скриншот 59 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_5/11_r2.png "Скриншот 60 - Существующие сетевые интерфейсы")

Скриншот 59 и 60 установка сетевых служб и вывод комманды `ip r`

![ipcalc](Pictures/Part_5/12_ws11.png "Скриншот 61 - Существующие сетевые интерфейсы")

Скриншот 61 Запустить команды на ws11:
`ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0`

#### 5.5. Построение списка маршрутизаторов
![ipcalc](Pictures/Part_5/13_ws11.png "Скриншот 62 - Существующие сетевые интерфейсы")
![ipcalc](Pictures/Part_5/12_r2.png "Скриншот 63 - Существующие сетевые интерфейсы")

Скриншот 62 и 63 Запуск на r1 команду дампа:
`tcpdump -tnv -i enp0s3`
При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21


- Отправляется серию пакетов ближайшему узлу с TTL = 1, где TTL - время жизни, сколько узлов прошёл.
Если этот узел не необходимый, то вовзращает пакет прошлому узлу, с сообщением, что отправитель не найден; и отправляется другой пакет, с увеличенным TTL, на все остальные, доступные, узлы.
И так проверяются все узлы, находя нужный. После чего идут обратные пакеты, что пакет дошёл до адресата, соответсвенно идёт от адресата до отправителя.

#

![ipcalc](Pictures/Part_5/13.png "Скриншот 64 - Существующие сетевые интерфейсы")

Скриншот 64 Запуск на r1 перехвата сетевого трафика, проходящего через enp0s3 с помощью команды:
`tcpdump -n -i enp0s3 icmp`
Пропингование с ws11 несуществующий IP

## Part 6. Динамическая настройка IP с помощью **DHCP**



![ipcalc](Pictures/Part_6/1_r2.png "Скриншот 65 - Существующие сетевые интерфейсы")
Скриншот 65 - Для r2 настройка в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**

![ipcalc](Pictures/Part_6/2_r2.png "Скриншот 66 - Существующие сетевые интерфейсы")
Скриншот 66 - Запись `ameserver 8.8.8.8` в /etc/resolv.conf
#
![ipcalc](Pictures/Part_6/3_r2.png "Скриншот 67 - Существующие сетевые интерфейсы")
Скриншот 67 - Перезапуск DHCP сервера с `systemctl restart isc-dhcp-server`
#
![ipcalc](Pictures/Part_6/4_цы21.png "Скриншот 68 - Существующие сетевые интерфейсы")
Скриншот 68 - Перезапуск ws21 и вызов ip a
#
![ipcalc](Pictures/Part_6/5_ws21.png "Скриншот 69 - Существующие сетевые интерфейсы")
Скриншот 69 - Пропинговка ws21 с ws22
#
![ipcalc](Pictures/Part_6/6_ws11.png "Скриншот 70 - Существующие сетевые интерфейсы")
Скриншот 70 - Указание МАК адресса для ws11 10:10:10:10:10:BA(и отметка dhcp4 - true)
#
![ipcalc](Pictures/Part_6/7_r1.png "Скриншот 71 - Существующие сетевые интерфейсы")
![ipcalc](Pictures/Part_6/7_5_r1.png "Скриншот 72 - Существующие сетевые интерфейсы")
![ipcalc](Pictures/Part_6/8_r1.png "Скриншот 73 - Существующие сетевые интерфейсы")
Скриншот 71-73  - Настройка r1 также как и r1 но дополнительное указание МАК адресс для ws11
#
![ipcalc](Pictures/Part_6/9_ws11.png "Скриншот 74 - Существующие сетевые интерфейсы")
![ipcalc](Pictures/Part_6/10_ws11.png "Скриншот 75 - Существующие сетевые интерфейсы")
Скриншот 74-75  - Проверка настройки для r1
#
![ipcalc](Pictures/Part_6/11_ws21.png "Скриншот 76 - Существующие сетевые интерфейсы")
Скриншот 76  - Проверка изменения ip в ws21

## Part 7. **NAT**
![ipcalc](Pictures/Part_7/1_r1.png "Скриншот 77 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_7/2_ws22.png "Скриншот 78 - Существующие сетевые интерфейсы")
Скриншот 77 - 78 - В файле `/etc/apache2/ports.conf` на ws22 и r1 изменение строки Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным
#
![ipcalc](Pictures/Part_7/3_r1.png "Скриншот 79 - Существующие сетевые интерфейсы")

![ipcalc](Pictures/Part_7/4_ws22.png "Скриншот 80 - Существующие сетевые интерфейсы")
Скриншот 79 - 80 - Запуск веб-сервера Apache командой `service apache2 start` на ws22 и r1

#

![ipcalc](Pictures/Part_7/5_r2.png "Скриншот 81 - Существующие сетевые интерфейсы")
Скриншот 81  - 
Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
1) удаление правил в таблице filter - iptables -F
2) удаление правил в таблице "NAT" - iptables -F -t nat
3) отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP
#
![ipcalc](Pictures/Part_7/6_r2.png "Скриншот 82 - Существующие сетевые интерфейсы")
Скриншот 82 - запуск скрипта
#

![ipcalc](Pictures/Part_7/7_r2.png "Скриншот 83 - Существующие сетевые интерфейсы")
Скриншот 83 Проверка соединения между ws22 и r1
#
![ipcalc](Pictures/Part_7/8_r2.png "Скриншот 83 - Существующие сетевые интерфейсы")
Скриншот 83 - Обновление firewall
- Включение SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2
- Включение DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

#
![ipcalc](Pictures/Part_7/9_r2.png "Скриншот 84 - Существующие сетевые интерфейсы")
Скриншот 84 - Запуск скрипта

#

![ipcalc](Pictures/Part_7/10_ws22.png "Скриншот 85 - Существующие сетевые интерфейсы")

Скриншот 85 - Проверка соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1

#
![ipcalc](Pictures/Part_7/11_r1.png "Скриншот 86 - Существующие сетевые интерфейсы")

Скриншот 86 - Проверка соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22


## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

- Создание firewall для r2 как в Part_7

#

![ipcalc](Pictures/Part_8/1_ws22.png "Скриншот 87 - Существующие сетевые интерфейсы")

Скриншот 87 - Изменение порта на localhost в apache

#
![ipcalc](Pictures/Part_8/2_ws22.png "Скриншот 88 - Существующие сетевые интерфейсы")

Скриншот 88 - Старт сервера apache2

#

![ipcalc](Pictures/Part_8/3_ws21.png "Скриншот 89 - Существующие сетевые интерфейсы")

Скриншот 89 - Использование *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

`ssh -L 5555:localhost:80 10.20.0.20`

#
![ipcalc](Pictures/Part_8/3_5_цы11.png "Скриншот 90 - Существующие сетевые интерфейсы")

Скриншот 90 - Проверка соединения 
#

![ipcalc](Pictures/Part_8/4_ws11.png "Скриншот 91 - Существующие сетевые интерфейсы")

Скриншот 91 - Использование *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11


`ssh -R 5555:localhost:80 10.20.0.20`

#
![ipcalc](Pictures/Part_8/5_ws11.png "Скриншот 92 - Существующие сетевые интерфейсы")

Скриншот 92 - Проверка соединения 



















